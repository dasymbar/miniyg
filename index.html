<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>Blackjack Mini App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
      body {
        background-color: #0b0b0b;
        color: #fff;
        font-family: Arial, sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        text-align: center;
      }
      button {
        background-color: #007aff;
        color: white;
        border: none;
        padding: 10px 20px;
        margin: 10px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
      }
      button:hover {
        background-color: #005ecc;
      }
      .row {
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <h1>üÉè Blackjack</h1>
    <div id="player"></div>
    <div id="dealer"></div>
    <div class="row">
      <button id="hit">–í–∑—è—Ç—å –∫–∞—Ä—Ç—É</button>
      <button id="stand">–°—Ç–æ–ø</button>
      <button id="restart" style="display:none;">–°—ã–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</button>
    </div>

    <script>
      const tg = window.Telegram.WebApp;
      tg.expand();

      const deck = ["2", "3", "4", "5", "6", "7", "8", "9", "10", "J", "Q", "K", "A"];

      function getValue(card) {
        if (["J", "Q", "K"].includes(card)) return 10;
        if (card === "A") return 11;
        return parseInt(card);
      }

      function handValue(hand) {
        let total = hand.map(getValue).reduce((a, b) => a + b, 0);
        let aces = hand.filter(c => c === "A").length;
        while (total > 21 && aces > 0) {
          total -= 10;
          aces--;
        }
        return total;
      }

      let player, dealer;

      function startGame() {
        player = [draw(), draw()];
        dealer = [draw(), draw()];
        updateUI();
        document.getElementById("hit").style.display = "inline-block";
        document.getElementById("stand").style.display = "inline-block";
        document.getElementById("restart").style.display = "none";
      }

      function draw() {
        return deck[Math.floor(Math.random() * deck.length)];
      }

      function updateUI() {
        document.getElementById("player").innerHTML =
          `–ò–≥—Ä–æ–∫: ${player.join(" ")} (—Å—É–º–º–∞: ${handValue(player)})`;
        document.getElementById("dealer").innerHTML =
          `–î–∏–ª–µ—Ä: ${dealer[0]} ‚ùì`;
      }

      document.getElementById("hit").onclick = () => {
        player.push(draw());
        if (handValue(player) >= 21) endGame();
        updateUI();
      };

      document.getElementById("stand").onclick = endGame;
      document.getElementById("restart").onclick = startGame;

      function endGame() {
        document.getElementById("hit").style.display = "none";
        document.getElementById("stand").style.display = "none";
        document.getElementById("restart").style.display = "inline-block";

        while (handValue(dealer) < 17) dealer.push(draw());
        const pVal = handValue(player);
        const dVal = handValue(dealer);

        let result = "";
        if (pVal > 21) result = "–¢—ã –ø—Ä–æ–∏–≥—Ä–∞–ª üò¢ (–ø–µ—Ä–µ–±–æ—Ä)";
        else if (dVal > 21) result = "–¢—ã –≤—ã–∏–≥—Ä–∞–ª üéâ (–¥–∏–ª–µ—Ä –ø–µ—Ä–µ–±—Ä–∞–ª)";
        else if (pVal > dVal) result = "–¢—ã –≤—ã–∏–≥—Ä–∞–ª üéâ";
        else if (pVal < dVal) result = "–¢—ã –ø—Ä–æ–∏–≥—Ä–∞–ª üò¢";
        else result = "–ù–∏—á—å—è ü§ù";

        document.getElementById("dealer").innerHTML =
          `–î–∏–ª–µ—Ä: ${dealer.join(" ")} (—Å—É–º–º–∞: ${dVal})`;

        const gameData = {
          message: result,
          player: player.join(" "),
          dealer: dealer.join(" "),
          score: pVal
        };

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ Telegram
        if (window.Telegram && Telegram.WebApp) {
          tg.sendData(JSON.stringify(gameData));
        } else {
          alert("‚ö†Ô∏è Telegram API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –û—Ç–∫—Ä–æ–π –∏–≥—Ä—É —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –≤ –±–æ—Ç–µ.");
        }
      }

      startGame();
    </script>
  </body>
</html>
